# =============================================================================
# MirageVulkan CI/CD Pipeline
# =============================================================================
# Runs on: push to master, pull requests
# Tests: 16 test suites (Google Test)
# Build: Windows with Vulkan SDK, FFmpeg, libusb
# =============================================================================

name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

env:
  BUILD_TYPE: Release
  VULKAN_SDK_VERSION: "1.3.290.0"

jobs:
  build-and-test:
    runs-on: windows-latest

    steps:
      # =======================================================================
      # Checkout
      # =======================================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # =======================================================================
      # Cache dependencies
      # =======================================================================
      - name: Cache Vulkan SDK
        id: cache-vulkan
        uses: actions/cache@v4
        with:
          path: C:\VulkanSDK
          key: vulkan-sdk-${{ env.VULKAN_SDK_VERSION }}-windows

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            C:\vcpkg\installed
            C:\vcpkg\packages
          key: vcpkg-windows-${{ hashFiles('CMakeLists.txt') }}
          restore-keys: |
            vcpkg-windows-

      # =======================================================================
      # Install Vulkan SDK
      # =======================================================================
      - name: Install Vulkan SDK
        if: steps.cache-vulkan.outputs.cache-hit != 'true'
        run: |
          $installer = "VulkanSDK-${{ env.VULKAN_SDK_VERSION }}-Installer.exe"
          $url = "https://sdk.lunarg.com/sdk/download/${{ env.VULKAN_SDK_VERSION }}/windows/$installer"
          Invoke-WebRequest -Uri $url -OutFile $installer
          Start-Process -FilePath ".\$installer" -ArgumentList "--accept-licenses --default-answer --confirm-command install" -Wait
          Remove-Item $installer
        shell: pwsh

      - name: Set Vulkan environment
        run: |
          echo "VULKAN_SDK=C:\VulkanSDK\${{ env.VULKAN_SDK_VERSION }}" >> $env:GITHUB_ENV
          echo "C:\VulkanSDK\${{ env.VULKAN_SDK_VERSION }}\Bin" >> $env:GITHUB_PATH
        shell: pwsh

      # =======================================================================
      # Install dependencies via vcpkg
      # =======================================================================
      - name: Install vcpkg dependencies
        run: |
          vcpkg install libusb:x64-windows
          vcpkg integrate install
        shell: pwsh

      # =======================================================================
      # Configure CMake
      # =======================================================================
      - name: Configure CMake
        run: |
          cmake -B build -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DBUILD_TESTS=ON `
            -DUSE_VULKAN_VIDEO=ON `
            -DUSE_FFMPEG=OFF `
            -DUSE_LIBUSB=ON `
            -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
        shell: pwsh

      # =======================================================================
      # Build
      # =======================================================================
      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel
        shell: pwsh

      # =======================================================================
      # Run Tests
      # =======================================================================
      - name: Run Tests
        working-directory: build
        run: ctest -C ${{ env.BUILD_TYPE }} --output-on-failure --timeout 120
        shell: pwsh

      # =======================================================================
      # Upload test results on failure
      # =======================================================================
      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            build/Testing/
            build/**/*.log

  # ===========================================================================
  # Code quality checks (lightweight, fast)
  # ===========================================================================
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check line endings
        run: |
          # Ensure no CRLF in source files (except Windows-specific)
          if git ls-files -z '*.cpp' '*.hpp' '*.h' | xargs -0 grep -l $'\r' 2>/dev/null; then
            echo "Warning: Some files have CRLF line endings"
          fi

      - name: Check for debug code
        run: |
          # Warn if debug code is left in
          if grep -rn "TODO\|FIXME\|HACK\|XXX" src/ --include="*.cpp" --include="*.hpp" | head -20; then
            echo "Note: Found TODO/FIXME comments (not blocking)"
          fi

      - name: Check include guards
        run: |
          # Verify all headers have include guards or #pragma once
          for f in $(find src -name "*.hpp" -o -name "*.h"); do
            if ! head -5 "$f" | grep -q "#pragma once\|#ifndef"; then
              echo "Warning: $f may be missing include guard"
            fi
          done
