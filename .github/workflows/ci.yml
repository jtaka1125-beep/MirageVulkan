name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-and-test:
    name: Build & Test (Windows / MinGW)
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure (CMake)
        shell: cmd
        run: |
          set PATH=C:\msys64\mingw64\bin;C:\msys64\usr\bin;%PATH%
          if not exist build mkdir build
          cd build
          cmake .. -G "MinGW Makefiles" ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DBUILD_TESTS=ON ^
            -DUSE_VULKAN_VIDEO=ON ^
            -DUSE_LIBUSB=ON

      - name: Build (tests)
        shell: cmd
        run: |
          set PATH=C:\msys64\mingw64\bin;C:\msys64\usr\bin;%PATH%
          cd build
          mingw32-make -j4 2>&1

      - name: Run tests (ctest)
        shell: cmd
        run: |
          set PATH=C:\msys64\mingw64\bin;C:\msys64\usr\bin;%PATH%
          cd build
          ctest --output-on-failure --parallel 4

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: build/Testing/
          retention-days: 7
